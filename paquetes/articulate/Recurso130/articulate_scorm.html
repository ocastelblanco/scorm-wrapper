<!DOCTYPE html>
<html lang="es">

<head>
  <meta http-equiv="cache-control"
        content="no-cache">
  <meta name="viewport"
        content="width=device-width, initial-scale=1">
  <meta name="format-detection"
        content="telephone=no">
  <title>Wrapper</title>
</head>

<body style="margin:0">
  <script>
    function API_1484_11() { };
    const API = API_1484_11;
    let data = '';
    const obj = {
      action: '',
      value: null
    };
    let numRecurso = 0;
    API.Initialize = () => {
      obj.action = 'Initialize';
      obj.value = null;
      return enviaPostMessage();
    }
    API.Commit = () => {
      obj.action = 'Commit';
      obj.value = null;
      return enviaPostMessage();
    }
    API.Terminate = () => {
      obj.action = 'Terminate';
      obj.value = null;
      return enviaPostMessage();
    }
    API.SetValue = (atributo, valor) => {
      // Tampoco se hace JSON.parse() para cargar variable
      const datos = data; // JSON.parse(data);
      datos[atributo] = valor;
      data = JSON.stringify(datos);
      obj.action = 'SetValue';
      obj.value = {};
      obj.value[atributo] = valor;
      return valor ? enviaPostMessage() : false;
    }
    API.GetValue = (atributo) => {
      let datos = data;
      if (atributo == 'cmi.suspend_data') {
        // En esta versión NO se hace JSON.parse()
        //datos = JSON.parse(data);
        // datos[atributo] = JSON.parse(datos[atributo]) ?? datos[atributo];
      }
      console.log('WRAPPER: GetValue ' + atributo + ': ', datos[atributo]);
      return JSON.stringify(datos[atributo]);
    };
    API.GetLastError = () => {
      obj.action = 'GetLastError';
      obj.value = null;
      return enviaPostMessage('0');
    };
    function enviaPostMessage(respuesta = 'true') {
      console.log('WRAPPER: ', obj);
      parent.window.postMessage(obj, '*');
      return respuesta;
    }
    window.addEventListener(
      "message",
      (event) => {
        if (typeof event.data == 'object' && event.data['cmi.suspend_data']) {
          console.log('WRAPPER: Recibo datos del PARENT = ', event.data);
          data = JSON.stringify(event.data ?? {});
        }
      },
      false
    );
    cargaRecurso();
    // Verifica cada 100ms si ya se han obtenido los datos en data. De ser así, carga el iframe con el recurso
    function cargaRecurso() {
      let timer = 0;
      const interval = setInterval(() => {
        timer++;
        if (data != '' || timer > 20) {
          clearInterval(interval);
          const iframe = document.createElement('iframe');
          iframe.setAttribute('style', 'height:100vh;width:100vw;border:none');
          iframe.src = 'index_lms.html';
          document.body.appendChild(iframe);
          iframe.onload = () => {
            // Se detecta el click en cualquier elemento; si es un <a> se envía la información por PostMessage
            iframe.contentWindow.document.addEventListener('click', (ev) => {
              ev.stopImmediatePropagation();
              ev.preventDefault();
              ev.stopPropagation();
              const elemento = ev.target || ev.srcElement;
              if (elemento.tagName === 'A') {
                const mensaje = {
                  action: 'enlace',
                  value: elemento.href
                };
                parent.window.postMessage(mensaje, '*');
                return false;
              }
              return false;
            });
          };
        }
      }, 100);
    }
  </script>
</body>

</html>